<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Investimento ETF Live Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
  body {
    margin: 0; padding: 20px; background: #0f172a; color: #f8fafc;
    font-family: 'Poppins', sans-serif;
    display: flex; justify-content: center; align-items: center; min-height: 100vh;
  }
  .container {
    background: #1e293b;
    border-radius: 20px;
    box-shadow: 0 0 30px rgba(56,189,248,0.3);
    max-width: 1000px; /* Aumentato per migliore visualizzazione */
    width: 100%;
    padding: 30px;
    box-sizing: border-box;
  }
  h1 {
    text-align: center;
    color: #38bdf8;
    font-weight: 700;
    margin-bottom: 25px;
    font-size: 2.5rem;
    letter-spacing: 1px;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .stat-card {
    background: #0f172a;
    padding: 20px 25px;
    border-radius: 15px;
    box-shadow: inset 0 0 15px rgba(56,189,248,0.1);
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .stat-card h2 {
    font-weight: 600;
    font-size: 1.1rem;
    color: #94a3b8;
    margin-bottom: 8px;
  }
  .stat-card p {
    font-size: 2.2rem;
    font-weight: 700;
    color: #f1f5f9;
    margin: 0;
  }
  .stat-card .value-change {
    font-size: 1.2rem;
    font-weight: 600;
    margin-top: 5px;
  }
  .stat-card .value-change.positive { color: #22c55e; } /* Tailwind green-500 */
  .stat-card .value-change.negative { color: #ef4444; } /* Tailwind red-500 */
  .stat-card .value-change.neutral { color: #94a3b8; }

  .chart-area {
    background: #0f172a;
    border-radius: 16px;
    box-shadow: inset 0 0 20px rgba(56,189,248,0.1);
    padding: 20px; /* Spaziatura interna per il grafico */
    height: 400px; /* Altezza fissa per il grafico */
    display: flex;
    justify-content: center;
    align-items: center;
  }
  canvas {
    max-height: 100%;
    max-width: 100%;
  }
  #currentDateTime {
    margin-top: 20px;
    text-align: center;
    font-weight: 500;
    font-size: 1rem;
    color: #94a3b8;
    user-select: none;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Investimento ETF Live Dashboard</h1>
  
  <div class="stats-grid">
    <div class="stat-card">
      <h2>Investimento Iniziale</h2>
      <p>€10.000,00</p>
    </div>
    <div class="stat-card">
      <h2>Valore Attuale</h2>
      <p id="currentValue">€10.000,00</p>
    </div>
    <div class="stat-card">
      <h2>Variazione Ultimo Secondo</h2>
      <p id="secondChangePercent" class="value-change neutral">0.0000%</p>
      <span id="secondChangeAmount" class="value-change neutral">€0.00</span>
    </div>
    <div class="stat-card">
      <h2>Stato Obiettivo</h2>
      <p id="goalStatus">Monitoraggio</p>
    </div>
  </div>

  <div class="chart-area">
    <canvas id="etfChart"></canvas>
  </div>
  <div id="currentDateTime"></div>
</div>

<script>
  // --- Configurazione Iniziale ---
  const ctx = document.getElementById('etfChart').getContext('2d');
  const initialCapital = 10000;
  const targetValue = 14980;
  const simulationDays = 120; // Giorni totali per raggiungere l'obiettivo

  // Calcolo del tasso di crescita giornaliero target (composto)
  const targetDailyRate = Math.pow(targetValue / initialCapital, 1 / simulationDays) - 1;

  // Calcolo del tasso di crescita per secondo, assumendo 86400 secondi in un giorno
  const secondsInADay = 24 * 60 * 60;
  const targetPerSecondRate = Math.pow(1 + targetDailyRate, 1 / secondsInADay) - 1;

  // Rumore/volatilità per ogni secondo (simula le "onde")
  const noiseFactor = 0.00005; 

  // --- Recupero dello Stato (Persistenza) ---
  let currentValue = localStorage.getItem('etfValue') ? parseFloat(localStorage.getItem('etfValue')) : initialCapital;
  let dataPoints = localStorage.getItem('etfHistory') 
    ? JSON.parse(localStorage.getItem('etfHistory')).map(p => ({ x: new Date(p.x), y: p.y }))
    : [{ x: new Date(), y: currentValue }]; 
  
  let simulatedDayCounter = localStorage.getItem('simulatedDayCounter') ? parseInt(localStorage.getItem('simulatedDayCounter')) : 0;

  // --- Funzioni di Utility ---
  function updateDateTimeDisplay() {
    const now = new Date();
    document.getElementById('currentDateTime').textContent = 
      "Data e ora attuali: " + now.toLocaleString('it-IT', { 
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit' 
      });
  }
  setInterval(updateDateTimeDisplay, 1000);
  updateDateTimeDisplay(); // Esegui subito all'avvio

  // --- Configurazione e Inizializzazione del Grafico ---
  const etfChart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        label: 'Valore ETF (€)',
        data: dataPoints,
        parsing: {
          xAxisKey: 'x',
          yAxisKey: 'y'
        },
        borderColor: '#38bdf8',
        backgroundColor: 'rgba(56,189,248,0.15)',
        fill: true,
        tension: 0.4,
        pointRadius: 0,
        borderWidth: 3,
      }]
    },
    options: {
      animation: {
          duration: 0
      },
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'second',
            tooltipFormat: 'dd/MM/yyyy HH:mm:ss',
            displayFormats: {
              second: 'HH:mm:ss'
            }
          },
          ticks: { 
            color: '#94a3b8', 
            maxRotation: 0, 
            minRotation: 0,
            autoSkip: true,
            maxTicksLimit: 10 
          },
          title: { display: true, text: 'Tempo Live', color: '#94a3b8' },
          grid: {
            color: 'rgba(148, 163, 184, 0.1)'
          }
        },
        y: {
          ticks: { 
            color: '#94a3b8', 
            callback: v => '€' + v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.')
          },
          title: { display: true, text: 'Valore (€)', color: '#94a3b8' },
          beginAtZero: false,
          grid: {
            color: 'rgba(148, 163, 184, 0.1)'
          }
        }
      },
      plugins: {
        legend: { 
          labels: { 
            color: '#f8fafc', 
            font: { size: 14, weight: 'bold' } 
          } 
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: ctx => `Valore: €${ctx.parsed.y.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`,
            title: function(tooltipItems) {
                return tooltipItems[0].label;
            }
          },
          backgroundColor: '#334155',
          bodyColor: '#f1f5f9',
          titleColor: '#38bdf8',
          borderColor: '#38bdf8',
          borderWidth: 1,
          padding: 10
        }
      },
      interaction: {
        mode: 'index',
        intersect: false
      }
    }
  });

  // --- Logica di Aggiornamento Dati ---
  function updateInvestment() {
    let lastPoint = dataPoints[dataPoints.length - 1];
    let newDate = new Date(lastPoint.x);
    newDate.setSeconds(newDate.getSeconds() + 1);

    const fluctuation = (Math.random() * 2 - 1) * noiseFactor;
    let actualPerSecondRate = targetPerSecondRate + fluctuation;

    if (actualPerSecondRate < -0.00002) actualPerSecondRate = -0.00002;

    let prevValue = currentValue;
    currentValue = currentValue * (1 + actualPerSecondRate);

    if (currentValue < 0.01) currentValue = 0.01; 

    dataPoints.push({ x: newDate, y: currentValue });

    const maxPoints = 300; 
    if(dataPoints.length > maxPoints) {
        dataPoints.shift();
    }

    etfChart.data.datasets[0].data = dataPoints;
    etfChart.update('none');

    document.getElementById('currentValue').textContent = '€' + currentValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    const secondChangePercent = ((currentValue - prevValue) / prevValue) * 100;
    const secondChangeAmount = currentValue - prevValue;

    const percentElement = document.getElementById('secondChangePercent');
    const amountElement = document.getElementById('secondChangeAmount');

    percentElement.textContent = `${secondChangePercent.toFixed(4)}%`;
    amountElement.textContent = `${secondChangeAmount >= 0 ? '+' : ''}€${secondChangeAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;

    if (secondChangePercent > 0) {
        percentElement.className = 'value-change positive';
        amountElement.className = 'value-change positive';
    } else if (secondChangePercent < 0) {
        percentElement.className = 'value-change negative';
        amountElement.className = 'value-change negative';
    } else {
        percentElement.className = 'value-change neutral';
        amountElement.className = 'value-change neutral';
    }

    const secondsInADay = 24 * 60 * 60; // Ripetuto per chiarezza
    simulatedDayCounter = Math.floor(dataPoints.length / secondsInADay); 
    
    if (simulatedDayCounter >= simulationDays && currentValue < targetValue) {
        document.getElementById('goalStatus').textContent = 'Obiettivo non raggiunto!';
        document.getElementById('goalStatus').style.color = '#ef4444';
        clearInterval(investmentInterval);
    } else if (currentValue >= targetValue) {
        document.getElementById('goalStatus').textContent = 'Obiettivo Raggiunto!';
        document.getElementById('goalStatus').style.color = '#22c55e';
        clearInterval(investmentInterval);
    } else {
        document.getElementById('goalStatus').textContent = `Monitoraggio (Giorno Sim. ${simulatedDayCounter}/${simulationDays})`;
        document.getElementById('goalStatus').style.color = '#f8fafc'; // Colore neutro iniziale
    }

    localStorage.setItem('etfValue', currentValue.toFixed(6));
    localStorage.setItem('etfHistory', JSON.stringify(dataPoints));
    localStorage.setItem('simulatedDayCounter', simulatedDayCounter);
  }

  let investmentInterval;

  // Inizia l'intervallo solo se la simulazione non è già finita
  if (currentValue < targetValue || simulatedDayCounter < simulationDays) {
      investmentInterval = setInterval(updateInvestment, 1000);
      updateInvestment(); // Esegui un aggiornamento immediato al caricamento
  } else {
      // Se la simulazione è già terminata al caricamento, aggiorna solo lo stato finale
      updateInvestment(); 
  }
</script>
</body>
</html>
